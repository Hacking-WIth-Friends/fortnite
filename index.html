<html>
	<head>
		<meta name="twitter:card" content="summary" />
		<meta name="twitter:site" content="@hexlify" />
		<meta name="twitter:creator" content="@hexlify" />
		<meta name="twitter:creator" content="tamm" />
		<meta property="og:url" content="https://fnite.se/" />
		<meta property="og:title" content="DHS18 Fortnite BYOC" />
		<meta property="og:description" content="Dreamhack Summer 2018 - Fortnite BYOC Score submission" />
		<meta property="og:image" content="https://fnite.se/logo.png" />
		<!-- A joint effort by Tamm and DoXiD to create a quick tournament site during DreamHack Summer 2018.
			Needless to say, we put this site together in less than 6 hours, some features were intended, some wasn't.
			All in the good spirit of hackathon.

			Thread lightly, Ye who enter here.. Here be dragons -->
		<style type="text/css">
			@font-face {
				font-family: LuckGuy;
				src: url(/LuckiestGuy-Regular.ttf);
			}

			body {
				background-image: url('./background.jpg');
				background-size: cover;
				background-position: center center;
				background-attachment: fixed;
			}

			#content {
				width: 300px;
				height: 380px;
				position: absolute;
				left: 50%;
				top: 50%;
				margin-left: -150px;
				margin-top: -162px;
				background-color: #272822;
				border: 1px solid #66D9EF;
			}

			#formFields {
				width: 202px;
				height: 320px;
				position: absolute;
				left: 50%;
				top: 40PX;
				margin-left: -101px;
			}

				#formFields > form > input {
					width: 202px;
					margin: 1px;
					padding: 5px;
					border: 1px solid #66D9EF;
					border-radius: 2px;
				}

				#formFields > form > p {
					font-size: 12px;
					color: #F8F8F0;
				}

					#formFields > form > p > b {
						font-size: 12px;
						color: #66D9EF;
					}

				#submit {
					position: absolute;
					left: 50%;
					bottom: 0px;
					width: 170px !important;
					margin-left: -85px !important;
				}

			#preview {
				position: absolute;
				right: -320px;
				top: 40px;
				width: 300px;
				max-height: 300px;
				visibility: hidden;
				border: 1px solid #66D9EF;
			}
			#solo {
				position: absolute;
				top: 50%;
				left: 50%;
				width: 140px;
				height: 40px;
				border: 1px solid #66D9EF;
				margin-top: -200px;
				margin-left: -150px;
				background-color: #272822;
				color: #F8F8F0;
				font-family: 'LuckGuy', cursive;
				text-align: center;
				line-height: 40px;
			}

			#duo {
				position: absolute;
				top: 50%;
				left: 50%;
				width: 140px;
				height: 40px;
				border: 1px solid #66D9EF;
				margin-top: -200px;
				margin-left: 10px;
				background-color: #272822;
				color: #F8F8F0;
				font-family: 'LuckGuy', cursive;
				text-align-last: center;
				line-height: 40px;
			}

			.active {
				background-color: #49483E !important;
			}

			.active > .solo {
				color: #66D9EF !important;
			}

			.duo {
				color: #FD971F !important;
			}

			#popup {
				background-color: #49483E !important;
				border: 1px solid #66D9EF;
				text-align-last: center;
				color: #F8F8F0;
			}

			#popup > h3 {
				font-family: 'LuckGuy', cursive;
			}

		</style>
		<script type="text/javascript">
			Element.prototype.remove = function() {
				this.parentElement.removeChild(this);
			}
			NodeList.prototype.remove = HTMLCollection.prototype.remove = function() {
				for(var i = this.length - 1; i >= 0; i--) {
					if(this[i] && this[i].parentElement) {
						this[i].parentElement.removeChild(this[i]);
					}
				}
			}

			var timers = {};
			function clearTimer(name) {
				if(timers[name] !== undefined) {
					window.clearInterval(timers[name]);
					return true;
				}
				return false;
			}

			function setTimer(name, func, time=10) {
				timers[name] = setInterval(func, time);
			}

			function submitScore() {
				let player_id_obj = document.getElementById('player_id');
				let player_id = '';
				if(typeof player_id_obj === 'undefined' || !player_id_obj) {
					player_id = document.getElementById('player_one').value + ', ' + document.getElementById('player_two').value;
					localStorage.setItem('player_one', document.getElementById('player_one').value);
					localStorage.setItem('player_two', document.getElementById('player_two').value);
				} else {
					player_id = player_id_obj.value;
					localStorage.setItem('username', player_id);
				}

				let placement = document.getElementById('placement').value;
				let kills = document.getElementById('kills').value;
				let screenshot = document.getElementById('preview').getAttribute('src');

				if (player_id == "") {
					showPopup("Error", "You need to enter a fortnite in-game player name.", true);
					document.getElementById('player_id').style.border='3px solid #FF0000';
					return;
				}
				if (placement == "") {
					showPopup("Error", "You need to enter what place you ended up in.", true);
					document.getElementById('placement').style.border='3px solid #FF0000';
					return;
				}
				if (kills == "") {
					showPopup("Error", "You need to enter how many kills you got.", true);
					document.getElementById('kills').style.border='3px solid #FF0000';
					return;
				}
				if (screenshot == "") {
					showPopup("Error", "You need to attach a screenshot for this game as evidence.", true);
					document.getElementById('addScreenie').style.border='3px solid #FF0000';
					document.getElementById('addScreenie').style.color='#FF0000';
					return;
				}

				if(kills != "" && placement != "" && screenshot != "") {
					var xhr = new XMLHttpRequest();
					xhr.open("POST", '/upload.php', true);

					//Send the proper header information along with the request
					xhr.setRequestHeader("Content-type", "application/json");

					xhr.onreadystatechange = function() {//Call a function when the state changes.
						let data = {};
						if(xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200) {
							data = JSON.parse(xhr.response);
						}
						if(xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200 && (typeof data['result'] !== 'undefined' && data['result'] != 'failed')) {
							let mode = localStorage.getItem('last_mode');
							if(mode && mode != 'duo')
								showSolo();
							else
								showDuo();

							showPopup('Success', 'Successfully submitted your score.');
						} else if (xhr.readyState == XMLHttpRequest.DONE) {
							showPopup('Failed', 'Could not submit your screenshot, try again later or contact E-Sport. Error code: ' + xhr.status + ' ('+data['reason']+')', true);
						}
					}
					xhr.send(JSON.stringify({"player_id": player_id, "placement": placement, "kills": kills, "screenshot": screenshot})); 
				}
			}

			function showPopup(title, content, error=false) {
				let popup = document.getElementById('popup');
				if(popup)
					popup.remove();

				popup = document.createElement('div');
				popup.id = 'popup';

				popup.innerHTML = '<h3 id="popup_title">'+title+'</h3>';
				popup.innerHTML += '<p>'+content+'</p>';


				document.body.appendChild(popup);
				if (error) {
					document.getElementById('popup_title').style.color = '#FD971F';
				}

				setTimer('clear_popup', function() {
					let popup = document.getElementById('popup');
					if(popup)
						popup.remove();
					clearTimer('clear_popup');
				}, 5000);
			}

			function showSolo() {
				let epicForm = document.getElementById('epicForm');
				let player_id = document.createElement('input');
				let description = document.createElement('p'); description.type = 'text';
				let placement = document.createElement('input'); placement.type = 'text';
				let kills = document.createElement('input'); kills.type = 'text';
				let file = document.createElement('input'); file.type = 'file';
				let addScreenie = document.createElement('input'); addScreenie.type='button';
				let br = document.createElement('br');
				let subButton = document.createElement('input');
				epicForm.innerHTML = '';

				player_id.type = 'text';
				player_id.name = 'player_id';
				player_id.id = 'player_id';
				player_id.placeholder = 'Your fortnite player name';

				description.innerHTML = 'Below, you will enter what placement you got and how many kills. For instance, if you got 3:d place with 10 kills, that will be <b>3</b> and <b>10</b> in the boxes below:'

				placement.id='placement';
				placement.placeholder = 'What place did you get?';
				kills.id = 'kills';
				kills.placeholder = 'How many kills did you get?';
				file.id='screenshot';
				file.style.display='none';
				addScreenie.id='addScreenie';
				addScreenie.value='Select Screenshot Evidence';
				addScreenie.addEventListener('click', function() {
					document.getElementById('screenshot').click();
				})

				subButton.type = 'button';
				subButton.value = 'Submit your score';
				subButton.id = 'submit';
				subButton.addEventListener('click', submitScore);

				let preview = document.createElement('img'); preview.id='preview';
				preview.src = '';


				epicForm.appendChild(player_id);
				epicForm.appendChild(description);
				epicForm.appendChild(placement);
				epicForm.appendChild(kills);
				epicForm.innerHTML += '<br><br>';
				epicForm.appendChild(file);
				epicForm.appendChild(addScreenie);
				epicForm.appendChild(subButton);
				epicForm.appendChild(preview);

//				document.getElementById('formFields').style.height = '280';
//				document.getElementById('content').style.height = '340';
				
				let username = localStorage.getItem('username');
				if(typeof username !== 'undefined' && username) {
					document.getElementById('player_id').value = username;
				}

				let fileForm = document.getElementById('screenshot');
				let imgPreview = document.getElementById('preview');

				fileForm.addEventListener('change', function(e) {
					var reader = new FileReader();

					reader.onload = function(e) {
						imgPreview.setAttribute('src', e.target.result);
						imgPreview.style.visibility = 'visible';
					}

					reader.readAsDataURL(fileForm.files[0]);
				});

				localStorage.setItem('last_mode', 'solo');
				let soloBtn = document.getElementById('solo');
				let duoBtn = document.getElementById('duo');
				duoBtn.className = '';
				soloBtn.classList.add('active');
				soloBtn.classList.add('solo');
			}

			function showDuo() {
				let epicForm = document.getElementById('epicForm');
				let input_player_one = document.createElement('input');
				let input_player_two = document.createElement('input');
				let description = document.createElement('p'); description.type = 'text';
				let placement = document.createElement('input'); placement.type = 'text';
				let kills = document.createElement('input'); kills.type = 'text';
				let file = document.createElement('input'); file.type = 'file';
				let addScreenie = document.createElement('input'); addScreenie.type='button';
				let subButton = document.createElement('input');
				epicForm.innerHTML = '';

				input_player_one.type = 'text';
				input_player_one.name = 'player_one';
				input_player_one.id = 'player_one';
				input_player_one.placeholder = 'Player one in your team';

				input_player_two.type = 'text';
				input_player_two.name = 'player_two';
				input_player_two.id = 'player_two';
				input_player_two.placeholder = 'Player two in your team';

				description.innerHTML = 'Below, you will enter what placement you got and how many kills. For instance, if you got 3:d place with 10 kills, that will be <b>3</b> and <b>10</b> in the boxes below:'

				placement.id='placement';
				placement.placeholder = 'What place did you get?';
				kills.id = 'kills';
				kills.placeholder = 'How many kills did you get?';
				file.id='screenshot';
				file.style.display='none';
				addScreenie.id='addScreenie';
				addScreenie.value='Select Screenshot Evidence';
				addScreenie.addEventListener('click', function() {
					document.getElementById('screenshot').click();
				})

				subButton.type = 'button';
				subButton.value = 'Submit your team score';
				subButton.id = 'submit';
				subButton.addEventListener('click', submitScore);

				let preview = document.createElement('img'); preview.id='preview';
				preview.src = '';

				epicForm.appendChild(input_player_one);
				epicForm.appendChild(input_player_two);
				epicForm.appendChild(description);
				epicForm.appendChild(placement);
				epicForm.appendChild(kills);
				epicForm.appendChild(file);
				epicForm.appendChild(addScreenie);
				epicForm.appendChild(subButton);
				epicForm.appendChild(preview);

//				document.getElementById('formFields').style.height = '280';
//				document.getElementById('content').style.height = '340';

				let player_one = localStorage.getItem('player_one');
				let player_two = localStorage.getItem('player_two');

				if(typeof player_one !== 'undefined' && player_one) {
					document.getElementById('player_one').value = player_one;
				}
				if(typeof player_two !== 'undefined' && player_two) {
					document.getElementById('player_two').value = player_two;
				}

				let fileForm = document.getElementById('screenshot');
				let imgPreview = document.getElementById('preview');

				fileForm.addEventListener('change', function(e) {
					var reader = new FileReader();

					reader.onload = function(e) {
						imgPreview.setAttribute('src', e.target.result);
						imgPreview.style.visibility = 'visible';
					}

					reader.readAsDataURL(fileForm.files[0]);
				});

				localStorage.setItem('last_mode', 'duo');

				let soloBtn = document.getElementById('solo');
				let duoBtn = document.getElementById('duo');
				soloBtn.className = '';
				duoBtn.classList.add('active');
				duoBtn.classList.add('solo');
			}

			window.onload = function() {
				let solo = document.getElementById('solo');
				let duo = document.getElementById('duo');

				solo.addEventListener('click', function(e) {
					showSolo();
				});

				duo.addEventListener('click', function(e) {
					showDuo();
				});

				let mode = localStorage.getItem('last_mode');
				if(mode && mode != 'duo')
					showSolo();
				else
					showDuo();
			}
		</script>
	</head>
	<body>
		<div id="solo">Solo</div> <div id="duo">Duo</div>
		<div id="content">
			<div id="formFields">
				<form method="POST" action="" id="epicForm">
				</form>
			</div>
			<img id="preview" src="">
		</div>
	</body>
</html>